name: CVC5 RQ2 Compare Baseline vs Variant1 Fuzzing

on:
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      commit_matrix: ${{ steps.generate-matrix.outputs.commit_matrix }}
      total_commits: ${{ steps.generate-matrix.outputs.total_commits }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Generate commit matrix from variant1 statistics
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # List commits that have both baseline and variant1 statistics
          prefix="evaluation/rq2/cvc5/fuzzing-statistics/variant1/"
          variant1_commits=$(aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/$prefix --recursive | \
            grep "fuzzing_statistics-" | \
            sed 's/.*fuzzing_statistics-\(.*\)\.json\.gz/\1/' | \
            sort -u)
          
          prefix="evaluation/rq2/cvc5/fuzzing-statistics/baseline/"
          baseline_commits=$(aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/$prefix --recursive | \
            grep "fuzzing_statistics-" | \
            sed 's/.*fuzzing_statistics-\(.*\)\.json\.gz/\1/' | \
            sort -u)
          
          # Find commits that have both
          commits=$(comm -12 <(echo "$variant1_commits" | sort) <(echo "$baseline_commits" | sort))
          
          commit_count=$(echo "$commits" | wc -l)
          echo "âœ… Found $commit_count commits with both baseline and variant1 statistics"
          
          # Generate matrix
          matrix_entries="[]"
          for commit in $commits; do
            matrix_entries=$(echo "$matrix_entries" | jq --arg commit "$commit" '. + [{"commit": $commit}]')
          done
          
          COMMIT_MATRIX=$(echo "{}" | jq --argjson include "$matrix_entries" '.include = $include')
          echo "commit_matrix=$COMMIT_MATRIX" >> $GITHUB_OUTPUT
          echo "total_commits=$commit_count" >> $GITHUB_OUTPUT

  compare-statistics:
    needs: generate-matrix
    if: needs.generate-matrix.outputs.total_commits != '' && needs.generate-matrix.outputs.total_commits != '0'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.commit_matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Compare statistics
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          python3 scripts/rq2/compare_fuzzing_statistics.py \
            --commit "$COMMIT_HASH" \
            --output comparison_$COMMIT_HASH.json
      
      - name: Upload comparison
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comparison-${{ matrix.commit }}
          path: comparison_${{ matrix.commit }}.json
          if-no-files-found: ignore

  aggregate-comparison:
    needs: [generate-matrix, compare-statistics]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Download all comparisons
        uses: actions/download-artifact@v4
        with:
          path: comparisons
          pattern: comparison-*
          merge-multiple: false
      
      - name: Aggregate comparisons
        run: |
          # Collect all comparison files
          echo "[]" > /tmp/all_comparisons.json
          for comp_file in comparisons/comparison-*/comparison_*.json; do
            if [ -f "$comp_file" ]; then
              jq -s '.[0] + [.[1]]' /tmp/all_comparisons.json "$comp_file" > /tmp/all_comparisons_new.json
              mv /tmp/all_comparisons_new.json /tmp/all_comparisons.json
            fi
          done
          
          # Calculate aggregate statistics using jq
          jq '{
            "aggregate": {
              "total_commits": length,
              "baseline_better_commits": [.[] | select(.summary.baseline_better > .summary.variant1_better)] | length,
              "variant1_better_commits": [.[] | select(.summary.variant1_better > .summary.baseline_better)] | length,
              "total_baseline_better_functions": [.[] | .summary.baseline_better] | add,
              "total_variant1_better_functions": [.[] | .summary.variant1_better] | add,
              "total_both_triggered_functions": [.[] | .summary.both_triggered] | add,
              "total_baseline_executions": [.[] | .summary.total_baseline_executions] | add,
              "total_variant1_executions": [.[] | .summary.total_variant1_executions] | add
            },
            "commits": .
          }' /tmp/all_comparisons.json > aggregated_comparison.json
          
          TOTAL_COMMITS=$(jq -r '.aggregate.total_commits' aggregated_comparison.json)
          BASELINE_BETTER=$(jq -r '.aggregate.total_baseline_better_functions' aggregated_comparison.json)
          VARIANT1_BETTER=$(jq -r '.aggregate.total_variant1_better_functions' aggregated_comparison.json)
          
          echo "âœ… Aggregated comparison for $TOTAL_COMMITS commits"
          echo "ðŸ“Š Baseline better: $BASELINE_BETTER functions"
          echo "ðŸ“Š Variant1 better: $VARIANT1_BETTER functions"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload aggregated comparison to S3
        if: always()
        run: |
          gzip -c aggregated_comparison.json > aggregated_comparison.json.gz
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "evaluation/rq2/cvc5/fuzzing-comparison/aggregated_comparison.json.gz" \
            --body aggregated_comparison.json.gz
          
          echo "âœ… Uploaded aggregated comparison to S3"

